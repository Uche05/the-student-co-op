{% extends "base.html" %}

{% block content %}
<div class="card max-w-md mx-auto p-8 shadow-xl rounded-2xl bg-white border border-gray-100">
    <h2 id="auth-title" class="text-navy text-3xl font-bold mb-2">Welcome Back</h2>
    <p id="auth-subtitle" class="text-gray-500 mb-8 text-sm">Please enter your student credentials.</p>
    
    <div class="space-y-4">
        <input type="email" id="email" placeholder="Student Email" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-electricBlue transition">
        
        <input type="password" id="password" placeholder="Password" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-electricBlue transition">
        
        <button type="button" id="main-btn" onclick="signInStudent()" class="btn w-full py-4 rounded-xl shadow-lg hover:bg-blue-700 transition duration-300">Sign In</button>
        
        <div class="flex justify-between items-center text-xs font-medium px-1">
            <button type="button" onclick="toggleAuthMode()" id="toggle-link" class="text-electricBlue hover:underline">Need an account? Sign Up</button>
            <button type="button" onclick="resetPassword()" class="text-gray-400 hover:text-navy">Forgot Password?</button>
        </div>
    </div>
    
    <p id="error-message" class="text-red-500 text-xs mt-6 text-center font-medium"></p>
    <p id="success-message" class="text-green-500 text-xs mt-6 text-center font-medium"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
    let isLoginMode = true;

    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('main-btn');
        const link = document.getElementById('toggle-link');
        
        if (isLoginMode) {
            title.innerText = "Welcome Back";
            btn.innerText = "Sign In";
            link.innerText = "Need an account? Sign Up";
        } else {
            title.innerText = "Create Account";
            btn.innerText = "Register Now";
            link.innerText = "Already have an account? Log In";
        }
    }

    const firebaseConfig = {
        apiKey: "AIzaSyAdAmKg-XA_Le6Yr5aByWHojl8sJwl73fw",
        authDomain: "student-co-op.firebaseapp.com",
        projectId: "student-co-op",
        storageBucket: "student-co-op.firebasestorage.app",
        messagingSenderId: "155211461603",
        appId: "1:155211461603:web:36b7968071a87ea21026d6",
        measurementId: "G-SF9HKE1QW5"
    };
    
    // Initialize Firebase only if not already initialized
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }

    async function signInStudent() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('error-message');
        
        // Clear previous errors
        errorDiv.innerText = "";

        try {
            console.log("Attempting Firebase Auth...");
            const userCredential = await firebase.auth().signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            console.log("Firebase Auth Success. UID:", user.uid);

            const idToken = await user.getIdToken();

            console.log("Sending token to Flask...");
            const response = await fetch('/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: idToken })
            });

            if (response.ok) {
                console.log("Flask Session Set. Redirecting...");
                window.location.href = "/dashboard";
            } else {
                const errorData = await response.json();
                errorDiv.innerText = "Flask Error: " + errorData.message;
            }
        } catch (error) {
            console.error("Full Error Object:", error);
            // This handles the 'invalid-credential' error specifically
            errorDiv.innerText = error.message;
        }
    }

    async function resetPassword() {
        const email = document.getElementById('email').value.trim();
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        
        if (!email) {
            errorDiv.innerText = "Please enter your email address first.";
            return;
        }

        try {
            await firebase.auth().sendPasswordResetEmail(email);
            successDiv.innerText = "Password reset email sent! Check your inbox.";
            errorDiv.innerText = "";
        } catch (error) {
            errorDiv.innerText = error.message;
        }
    }
    
</script>
{% endblock %}